{% extends "layout.html" %}
{% block pagetitle %}
Riwayat Inventaris Per Warehouse - {{ App.params.site_name }}
{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ 'lib/bootstrap-daterangepicker/daterangepicker-bs3.css' | admin_asset_url }}">
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.20/css/jquery.dataTables.min.css">

<div id="main_wrapper">
    <div class="page_bar clearfix">
        <div class="row">
            <div class="col-sm-6">
                <h1 class="page_title">
                    {% if not warehouse %}
                    Riwayat Inventaris Per Warehouse
                    {% else %}
                    Riwayat Inventaris di WH {{ warehouse.title }}
                    {% endif %}
                </h1>
                <p class="text-muted">Riwayat Inventaris di warehouse {{ warehouse.title }}</p>
            </div>
            <div class="col-sm-3">
                <select id="warehouse_from" name="Reports[warehouse_id]" class="form-control select2" onchange="selectWH(this)">
                    <option value="0">- Pilih Warehouse -</option>
                    {% for i, wh in warehouses %}
                    <option value="{{ wh.id }}" {% if warehouse and warehouse.id == wh.id %}selected="selected"{% endif %}>{{ wh.title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-sm-3 text-right">
                <div id="reportrange" class="btn">
                    <i class="fa fa-calendar"></i>
                    {% if params.date_start %}
                    <span>{{ params.date_start | date("M d, Y") }} - {{ params.date_end | date("M d, Y") }}</span> <b class="caret"></b>
                    {% else %}
                    <span>{{ "now" | date("M d, Y") }} - {{ "now" | date("M d, Y") }}</span> <b class="caret"></b>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="page_content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">Barang Masuk/Keluar di Warehouse {{ warehouse.title }}</div>
                        <div class="panel-body" style="overflow-x: scroll;">
                            <div class="dataTables_wrapper form-inline no-footer table-responsive mt20" role="grid">
                                <table id="dt_basic" class="table table-bordered dataTable2" style="width:100%">
                                    <thead>
                                    <tr>
                                        <th class="text-center">Date</th>
                                        <th class="text-center">Desc</th>
                                        <th class="text-center">From/To</th>
                                        {% for p, product in products %}
                                        <th class="text-center">{{ product.product_code }}</th>
                                        {% endfor %}
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% set no = 1 %}
                                    {% for i, data in datas %}
                                    <tr>
                                        <td class="text-center">{{ data.date_transfer | date('d M') }}</td>
                                        <td class="text-center">
                                            {% set items = [] %}{% set is_out = 0 %}
                                            {% if data.warehouse_from == warehouse.id %}
                                            {% set items = ti_model.getItems(data.id) %}
                                            {% set is_out = 1 %}
                                            <a href="{{ 'pos/transfers/update' | link }}/{{ data.id }}#detail" target="_blank">{{ data.ti_number }}</a>
                                            {% else %}
                                            {% set items = tr_model.getItems(data.tr_id) %}
                                            <a href="{{ 'pos/transfers/update-receipt' | link }}/{{ data.tr_id }}#detail" target="_blank">{{ data.tr_number | default('-') }}</a>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">{% if data.warehouse_from == warehouse.id %}<b>TO</b> {{ data.warehouse_to_name }}{% else %}<b>FROM</b> {{ data.warehouse_from_name }}{% endif %}</td>
                                        {% for p, product in products %}
                                        <td class="text-center">
                                            {% if items[product.product_id] %}
                                            {% if is_out %}-{% endif %}{{ items[product.product_id].quantity }}
                                            {% if items[product.product_id].selisih %}
                                            <br/><b>Missing ({{ items[product.product_id].quantity }} {{ items[product.product_id].selisih }})</b>
                                            {% endif %}
                                            {% else %}
                                            -
                                            {% endif %}
                                        </td>
                                        {% endfor %}
                                    </tr>
                                    {% set no = no + 1 %}
                                    {% else %}
                                    <tr class="no-data">
                                        <td colspan="4">No data founds</td>
                                    </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% include 'partial/right_menu.html' %}
{% endblock %}
{% block endbodyjs %}
<script src="{{ 'lib/bootstrap-daterangepicker/daterangepicker.js' | admin_asset_url }}"></script>
<script src="{{ 'lib/moment-js/moment.min.js' | admin_asset_url }}"></script>
{#<script src="{{ 'lib/DataTables/media/js/jquery.dataTables.min.js' | admin_asset_url }}"></script>#}
<script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>

<script src="https://cdn.datatables.net/buttons/1.6.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/1.6.1/js/buttons.html5.min.js"></script>
<script type="text/javascript">
    $(function() {
        initDateRage();
        tisa_enhanced_select.init();
    });

    function initDateRage() {
        if($('#reportrange').length) {
            if( $(window).width() < 974 ) {
                var dropdownPos = 'right';
            } else {
                var dropdownPos = 'left';
            }
            $('#reportrange').daterangepicker({
                    opens: dropdownPos,
                    ranges: {
                        'Today': [moment(), moment()],
                        'Yesterday': [moment().subtract('days', 1), moment().subtract('days', 1)],
                        'Last 7 Days': [moment().subtract('days', 6), moment()],
                        'Last 30 Days': [moment().subtract('days', 29), moment()],
                        'This Month': [moment().startOf('month'), moment().endOf('month')],
                        'Last Month': [moment().subtract('month', 1).startOf('month'), moment().subtract('month', 1).endOf('month')]
                    },
                    startDate: moment().subtract('days', 29),
                    endDate: moment(),
                    buttonClasses: ['btn','btn-sm']
                },
                function(start, end) {
                    $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
                    setDateRange(start, end);
                }
            );
        }
    }
    function setDateRange(start, end) {
        var loc = window.location;
        var currentURL = loc.protocol + '//' + loc.host + loc.pathname;
        var wh = gup('wh', loc);
        if (wh && wh.length > 0) {
            window.location.href = currentURL+'?wh='+wh+'&start='+start+'&end='+end;
        } else {
            window.location.href = currentURL+'?start='+start+'&end='+end;
        }
    }
    function gup( name, url ) {
        if (!url) url = location.href;
        name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
        var regexS = "[\\?&]"+name+"=([^&#]*)";
        var regex = new RegExp( regexS );
        var results = regex.exec( url );
        return results == null ? null : results[1];
    }
    tisa_enhanced_select = {
        init: function() {
            if($('.select2').length) {
                $('.select2').select2({
                    allowClear: true,
                    placeholder: "Select..."
                });
            }
        }
    }
    function selectWH(dt) {
        var loc = window.location;
        var currentURL = loc.protocol + '//' + loc.host + loc.pathname;
        if ($(dt).val() && parseInt($(dt).val()) > 0) {
            var start = gup('start', loc);
            var end = gup('end', loc);
            if (start && start.length >0 && end && end.length > 0)
                window.location.href = currentURL+'?wh='+$(dt).val()+'&start='+start+'&end='+end;
            else
                window.location.href = currentURL+'?wh='+$(dt).val();
        }
        return false;
    }
    function fnExcelReport()
    {
        var tab_text="<table border='2px'><tr bgcolor='#87AFC6'>";
        var textRange; var j=0;
        tab = document.getElementById('dt_basic'); // id of table

        for(j = 0 ; j < tab.rows.length ; j++)
        {
            tab_text=tab_text+tab.rows[j].innerHTML+"</tr>";
            //tab_text=tab_text+"</tr>";
        }

        tab_text=tab_text+"</table>";
        tab_text= tab_text.replace(/<A[^>]*>|<\/A>/g, "");//remove if u want links in your table
        tab_text= tab_text.replace(/<img[^>]*>/gi,""); // remove if u want images in your table
        tab_text= tab_text.replace(/<input[^>]*>|<\/input>/gi, ""); // reomves input params

        var ua = window.navigator.userAgent;
        var msie = ua.indexOf("MSIE ");

        if (msie > 0 || !!navigator.userAgent.match(/Trident.*rv\:11\./))      // If Internet Explorer
        {
            txtArea1.document.open("txt/html","replace");
            txtArea1.document.write(tab_text);
            txtArea1.document.close();
            txtArea1.focus();
            sa=txtArea1.document.execCommand("SaveAs",true,"Say Thanks to Sumit.xls");
        }
        else                 //other browser not tested on IE 11
            sa = window.open('data:application/vnd.ms-excel,' + encodeURIComponent(tab_text));

        return (sa);
    }
    $(function () {
        if ($('.dataTable2').length > 0) {
            var buttonCommon = {
                exportOptions: {
                    format: {
                        body: function ( data, row, column, node ) {
                            return data.includes(".") ?
                                data.replace( /[$.]/g, '' ) :
                                data;
                        }
                    }
                }
            };

            $('.dataTable2').DataTable( {
                dom: 'Bfrtip',
                buttons: [
                    'copyHtml5',
                    //'excelHtml5',
                    $.extend( true, {}, buttonCommon, {
                        extend: 'excelHtml5'
                    }),
                    $.extend( true, {}, buttonCommon, {
                        extend: 'csvHtml5'
                    }),
                    {
                        extend: 'pdfHtml5',
                        orientation: 'landscape',
                        pageSize: 'LEGAL'
                    }
                ],
                pageLength: 100,
                lengthChange: true
            } );
        }
    });
</script>
{% endblock %}
