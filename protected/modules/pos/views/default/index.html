{% extends "layout.html" %}
{% block pagetitle %}
Dashboard - {{ App.name }}
{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ 'lib/bootstrap-daterangepicker/daterangepicker-bs3.css' | admin_asset_url }}">
<!-- main content -->
<div id="main_wrapper">
    <div class="page_bar clearfix">
        <div class="row">
            <div class="col-sm-8">
                <h1 class="page_title">Dashboard</h1>
                <p class="text-muted">Selamat datang di {{ App.params.site_name }}. Anda dapat menggunakan data berikut untuk melihat efektifitas halaman website Anda.</p>
            </div>
            <div class="col-sm-4 text-right">
                <div id="reportrange" class="btn">
                    <i class="fa fa-calendar"></i>
                    {% if params.date_from %}
                    <span>{{ params.date_from | date("M d, Y") }} - {{ params.date_to | date("M d, Y") }}</span> <b class="caret"></b>
                    {% else %}
                    <span>{{ "now" | date("M d, Y") }} - {{ "now" | date("M d, Y") }}</span> <b class="caret"></b>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="page_content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-5">
                    <div class="panel panel-default">
                        <div class="panel-heading">Net revenue and visits</div>
                        <div class="panel-body">
                            <div id="report_revenue_visits" class="chart" style="height:300px;width:100%"></div>
                            <script>
                                data_visits = [
                                    [1391814000000,1240],
                                    [1391900400000,1140],
                                    [1391986800000,480],
                                    [1392073200000,630],
                                    [1392159600000,950],
                                    [1392246000000,590],
                                    [1392332400000,820],
                                    [1392418800000,540],
                                    [1392505200000,500]
                                ];
                                data_revenue = [
                                    [1391814000000,12451],
                                    [1391900400000,10271],
                                    [1391986800000,8457],
                                    [1392073200000,11951],
                                    [1392159600000,7587],
                                    [1392246000000,15367],
                                    [1392332400000,12548],
                                    [1392418800000,10491],
                                    [1392505200000,9531]
                                ];
                            </script>
                        </div>
                    </div>
                    <div class="panel panel-default">
                        <div class="panel-heading">Best sellers (top 10)</div>
                        <div class="panel-body panel_body_a">
                            <table class="table table-hover">
                                <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Product Revenue</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td>Amet rerum illo.</td>
                                    <td>$22,742.00</td>
                                </tr>
                                <tr>
                                    <td>Illum nobis.</td>
                                    <td>$18,421.00</td>
                                </tr>
                                <tr>
                                    <td>Quibusdam autem voluptatibus.</td>
                                    <td>$15,823.00</td>
                                </tr>
                                <tr>
                                    <td>Qui nihil qui.</td>
                                    <td>$10,967.00</td>
                                </tr>
                                <tr>
                                    <td>Quia dicta quis.</td>
                                    <td>$6,071.00</td>
                                </tr>
                                <tr>
                                    <td>Veritatis vero maxime.</td>
                                    <td>$3,233.00</td>
                                </tr>
                                <tr>
                                    <td>Rerum sit hic.</td>
                                    <td>$2,100.00</td>
                                </tr>
                                <tr>
                                    <td>Perspiciatis nam.</td>
                                    <td>$1,083.00</td>
                                </tr>
                                <tr>
                                    <td>Explicabo eveniet reiciendis.</td>
                                    <td>$641.00</td>
                                </tr>
                                <tr>
                                    <td>Sapiente vel omnis.</td>
                                    <td>$583.00</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="panel panel-default">
                        <div class="panel-heading">How many visitors?</div>
                        <div class="panel-body">
                            <div class="peity_stat clearfix">
                                <div class="pull-left">
                                    <h3 class="peity_text">12 681 <small>(11 398 unique)</small></h3>
                                </div>
                                <div class="peity_holder pull-right">
                                    <span class="peity_line">640,928,1281,727,1401,810,1085</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="panel panel-default">
                        <div class="panel-heading">How many orders?</div>
                        <div class="panel-body">
                            <div class="peity_stat clearfix">
                                <div class="pull-left">
                                    <h3 class="peity_text">827 <small>(725 completed)</small></h3>
                                </div>
                                <div class="peity_holder pull-right">
                                    <span class="peity_line">143,186,310,285,274,350,169</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="panel panel-default">
                        <div class="panel-heading">Source of revenue (top 3)</div>
                        <div class="panel-body">
                            <div id="report_revenue_sources" class="chart" style="height:300px;width:100%">
                                <script>
                                    data_revenue_sources = [
                                        { label: "Direct", data: 15486, color: '#3498db' },
                                        { label: "google.com", data: 4785, color: '#e74c3c' },
                                        { label: "Other", data: 2173, color: '#27ae60' }
                                    ];
                                </script>
                            </div>
                            <div id="report_revenue_sources_legend"></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3">
                    <div class="panel panel-default">
                        <div class="panel-heading">Revenue per day of the week</div>
                        <div class="panel-body">
                            <div id="report_revenue_per_day" class="chart" style="height:200px;width:100%">
                                <script>
                                    data_revenue_day = [
                                        [0,1240],
                                        [1,1140],
                                        [2,480],
                                        [3,630],
                                        [4,950],
                                        [5,590],
                                        [6,820]
                                    ];
                                </script>
                            </div>
                        </div>
                    </div>
                    <div class="panel panel-default">
                        <div class="panel-heading">Where do your customers live? (top 5)</div>
                        <div class="panel-body panel_body_a">
                            <table class="table table-hover">
                                <thead>
                                <tr>
                                    <th>Country/Teritory</th>
                                    <th>Unique Visits</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td>USA</td>
                                    <td>2 312</td>
                                </tr>
                                <tr>
                                    <td>Brazil</td>
                                    <td>1 745</td>
                                </tr>
                                <tr>
                                    <td>India</td>
                                    <td>1 237</td>
                                </tr>
                                <tr>
                                    <td>China</td>
                                    <td>842</td>
                                </tr>
                                <tr>
                                    <td>Turkey</td>
                                    <td>531</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% include 'partial/right_menu.html' %}
{% endblock %}
{% block endbodyjs %}
<script src="{{ 'lib/d3/d3.min.js' | admin_asset_url }}"></script>
<script src="{{ 'lib/novus-nvd3/nv.d3.min.js' | admin_asset_url }}"></script>
<!-- flot charts-->
<script src="{{ 'lib/flot/jquery.flot.min.js' | admin_asset_url }}"></script>
<script src="{{ 'lib/flot/jquery.flot.pie.min.js' | admin_asset_url }}"></script>
<script src="{{ 'lib/flot/jquery.flot.resize.min.js' | admin_asset_url }}"></script>
<script src="{{ 'lib/flot/jquery.flot.tooltip.min.js' | admin_asset_url }}"></script>
<!-- date range picker -->
<script src="{{ 'lib/bootstrap-daterangepicker/daterangepicker.js' | admin_asset_url }}"></script>
<!-- moment.js (date library) -->
<script src="{{ 'lib/moment-js/moment.min.js' | admin_asset_url }}"></script>
<script src="{{ 'lib/flot/jquery.flot.time.min.js' | admin_asset_url }}"></script>
{% set page_views = vmodel.getPageViewInterval(params.date_from, params.date_to) %}
<script type="text/javascript">
    $(function() {
        // nvd3 charts
        tisa_nvd3_charts.cumulativeLine();
        tisa_flot_charts.device();
        //charts
        tisa_report_chart.revenue_visits();
        tisa_report_chart.revenue_sources();
        tisa_report_chart.revenue_per_day();
        initDateRage();
    });
    tisa_nvd3_charts = {
        cumulativeLine: function() {
            if ($('#nvd3_cumulativeLine').length) {
                nv.addGraph(function() {
                    var chart = nv.models.cumulativeLineChart()
                            .useInteractiveGuideline(true)
                            .x(function(d) { return d[0] })
                            .y(function(d) { return d[1] })
                            .color(d3.scale.category20().range())
                            .transitionDuration(500)
                            .clipVoronoi(false);

                    chart.xAxis.tickFormat(function(d) {
                        return d3.time.format('%m/%d/%y')(new Date(d))
                    });

                    //chart.yAxis.tickFormat(d3.format(',.1%'));

                    d3.select('#nvd3_cumulativeLine svg').datum(cumulativeTestData()).call(chart);

                    nv.utils.windowResize(chart.update);

                    return chart;
                });

                function cumulativeTestData() {
                    var page_view_data = JSON.parse('{{ page_views.pageview | json_encode }}');
                    var session_data = JSON.parse('{{ page_views.session | json_encode }}');
                    return [
                        {
                            key: "PageView",
                            color: "#1f77b4",
                            values: page_view_data,
                        },
                        {
                            key: "Session",
                            color: "#ff7f0e",
                            values: session_data
                        }
                    ];
                }
            }
        }
    }
    tisa_flot_charts = {
        device: function () {
            if ($('#flot_device').length) {
                function labelFormatter(label, series) {
                    return "<div class=\"chart_label\">" + Math.round(series.percent) + "%</div>";
                }

                $.plot('#flot_device', chart_device_data, {
                    series: {
                        pie: {
                            show: true,
                            radius: 3 / 4,
                            label: {
                                show: true,
                                radius: 0.54,
                                formatter: labelFormatter,
                            }
                        }
                    }
                });
            }
        },
    }
    function initDateRage() {
        if($('#reportrange').length) {
            if( $(window).width() < 974 ) {
                var dropdownPos = 'right';
            } else {
                var dropdownPos = 'left';
            }
            $('#reportrange').daterangepicker({
                        opens: dropdownPos,
                        ranges: {
                            'Today': [moment(), moment()],
                            'Yesterday': [moment().subtract('days', 1), moment().subtract('days', 1)],
                            'Last 7 Days': [moment().subtract('days', 6), moment()],
                            'Last 30 Days': [moment().subtract('days', 29), moment()],
                            'This Month': [moment().startOf('month'), moment().endOf('month')],
                            'Last Month': [moment().subtract('month', 1).startOf('month'), moment().subtract('month', 1).endOf('month')]
                        },
                        startDate: moment().subtract('days', 29),
                        endDate: moment(),
                        buttonClasses: ['btn','btn-sm']
                    },
                    function(start, end) {
                        $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
                        setDateRange(start, end);
                    }
            );
        }
    }
    function setDateRange(start, end) {
        var loc = window.location;
        var currentURL = loc.protocol + '//' + loc.host + loc.pathname;
        window.location.href = currentURL+'?start='+start+'&end='+end;
    }
    // charts
    tisa_report_chart = {
        revenue_visits : function() {
            if($('#report_revenue_visits').length) {

                function dolarFormatter(v, axis) {
                    return "$"+v.toFixed(axis.tickDecimals) ;
                }

                var chart_placeholder = $('#report_revenue_visits');

                var options = {
                    grid: {
                        clickable: true,
                        hoverable: true,
                        autoHighlight: true,
                        backgroundColor: null,
                        borderWidth: 0,
                        color: "#666",
                        labelMargin: 10,
                        axisMargin: 0,
                        mouseActiveRadius: 10,
                        minBorderMargin: 5
                    },
                    series: {
                        lines: {
                            show: true,
                            lineWidth: 3,
                            steps: false
                        },
                        points: {
                            show:true,
                            radius: 4,
                            symbol: "circle",
                            fill: true
                        }
                    },
                    tooltip: true,
                    tooltipOpts: {
                        content: "%y <small class=\"text-muted\">(%x)</small>",
                        shifts: {
                            x: 20,
                            y: 0
                        },
                        defaultTheme: false
                    },
                    xaxis: {
                        mode: "time"
                    },
                    yaxes: [
                        {
                            min:0,
                        },
                        {
                            min:0,
                            tickFormatter: dolarFormatter,
                            position: "right"
                        }
                    ],
                    legend: {
                        noColumns: 0,
                        position: "ne"
                    },
                    colors: ["#d35400","#34495e"],
                    shadowSize: 0
                };

                $.plot(chart_placeholder,[{
                    label: "Visits",
                    data: data_visits,
                    points: {fillColor: '#fff'}
                },{
                    label: "Product Revenue",
                    data: data_revenue,
                    points: {fillColor: '#fff'},
                    yaxis: 2
                }],options);

            }
        },
        revenue_sources: function() {
            if ($('#report_revenue_sources').length) {
                function labelFormatter(label, series) {
                    return "<div class=\"chart_label\">" + Math.round(series.percent) + "%</div>";
                }
                $.plot('#report_revenue_sources', data_revenue_sources, {
                    series: {
                        pie: {
                            show: true,
                            radius: 3/4,
                            label: {
                                show: true,
                                radius: 0.54,
                                formatter: labelFormatter,
                            },
                            innerRadius: 0.35
                        }
                    },
                    legend: {
                        show: true,
                        noColumns: 0,
                        container:$("#report_revenue_sources_legend")
                    }
                });
            }
        },
        revenue_per_day: function() {
            if ($('#report_revenue_per_day').length) {

                function dolarFormatter(v, axis) {
                    return "$"+v.toFixed(axis.tickDecimals) ;
                }

                var data = [
                    {
                        data: data_revenue_day,
                        color: '#16a085',
                        label:'Revenue per day',
                        bars: {
                            show: true,
                            align:'center',
                            barWidth:0.3,
                            fill: 1
                        }
                    }
                ];

                $.plot('#report_revenue_per_day', data, {
                    grid: {
                        clickable: true,
                        hoverable: true,
                        autoHighlight: true,
                        backgroundColor: null,
                        borderWidth: 0,
                        color: "#666",
                        labelMargin: 10,
                        axisMargin: 0,
                        mouseActiveRadius: 10,
                        minBorderMargin: 5
                    },
                    yaxis: {
                        min: 0,
                        tickFormatter: dolarFormatter
                    },
                    xaxis: {
                        ticks: [[0,'Mon'],[1,'Tue'],[2,'Wed'],[3,'Thu'],[4,'Fri'],[5,'Sat'],[6,'Sun']],
                        autoscaleMargin: .10 // allow space left and right
                    },
                    tooltip: true,
                    tooltipOpts: {
                        content: function(label, xval, yval, flotItem) {
                            var week_day = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
                            return '$'+yval+'.00 <small class="text-muted">'+week_day[xval]+'</small>';
                        },
                        shifts: {
                            x: 20,
                            y: 0
                        },
                        defaultTheme: false
                    },
                    legend: {
                        show: false
                    }
                });
            }
        }
    }
</script>
{% endblock %}