{% set price_datas = App.call.model("\\Model\\WarehouseProductsModel", 'getData', {"warehouse_id":model.id}) %}
<div class="row">
    <div class="col-md-6">
        <form method="post" id="adjustment-form" class="mt20" action="{{ 'pos/warehouses/product-stock' | link }}/{{ model.id }}">
            <div class="alert alert-success" style="display: none;"></div>

            <div class="alert alert-warning">Pilih produk untuk melakukan adjustment atau penyesuaian stok.</div>

            {% for i, price_data in price_datas %}
            {% set configs = price_data.configs | json_decode %}
            <div class="col-md-12">
                <div class="form-group">
                    <label class="checkbox-inline">
                        <input type="checkbox" name="ProductStocks[product_id][]" class="product-id"
                               value="{{ price_data.product_id }}" onclick="showPriceBox(this);"> <b> {{ price_data.product_name | upper }}</b>
                    </label>
                    <div class="input-group mt20" style="display: none;">
                        <input type="text" name="ProductStocks[{{ price_data.product_id }}]"
                               placeholder="Masukkan jumlah stok dalam format angka. misal 25."
                               class="form-control" id="product-stock-{{ price_data.product_id }}" disabled="disabled">
                        <span class="input-group-addon">{{ price_data.product_unit }}</span>
                    </div>
                </div>
            </div>
            {% endfor %}
            <div class="col-md-12">
                <div class="form-group">
                    <input type="hidden" name="ProductStocks[warehouse_id]" value="{{ model.id }}">
                    <input type="submit" value="Simpan" class="btn btn-info btn-submit" style="display: none;">
                </div>
            </div>
        </form>
    </div>
    <div class="col-md-6">
        <h4 class="mb20"><b>Stok Terkini di {{ model.title }}</b></h4>
        <form method="post" id="cost-adjustment-form" action="{{ 'pos/warehouses/product-cost' | link }}/{{ model.id }}">
            <div class="alert alert-success" style="display: none;"></div>
        <table class="table table-bordered">
            <thead>
            <tr>
                <th class="text-center">No</th>
                <th class="text-center">Nama Produk</th>
                <th class="text-center">Jumlah Stok</th>
                <th class="text-center">Current Cost</th>
            </tr>
            </thead>
            {% for i, price_data in price_datas %}
            {% set configs =  price_data.product_config | json_decode %}
            {% set stock = App.call.model("\\Model\\ProductStocksModel", 'getStock', {"product_id":price_data.product_id, "warehouse_id":model.id}) %}
            <tr>
                <td class="text-center">{{ i+1 }}</td>
                <td><a href="{{ 'pos/products/update' | link }}/{{ price_data.product_id }}" target="_blank">{{ price_data.product_name }}</a></td>
                <td class="text-center">
                    {% if configs.avoid_stock %}
                    avoid stock
                    {% else %}
                    {{ stock | default(0) }}  {{ price_data.product_unit }}
                    {% endif %}
                </td>
                <td class="text-center">
                    {% if configs.avoid_stock %}
                    {% set current_cost = price_data.current_cost %}
                    {% if current_cost <= 0 %}
                        {% set current_cost = price_data.global_current_cost %}
                    {% endif %}
                    <center>
                    <input type="text" name="WarehouseProduct[current_cost][{{ price_data.product_id }}]" value="{{ current_cost }}" id="{{ price_data.product_id }}" class="form-control" style="max-width:120px;">
                    </center>
                    {% else %}
                    {{ price_data.current_cost | money_format | default(0) }}
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
            <input type="submit" class="btn btn-info" value="Ubah Current Cost">
        </form>
        <tbody>
    </div>
</div>


<style>
    .row + .row {margin-top: 0px;}
</style>
<script type="text/javascript">
    function showPriceBox(dt) {
        var ps = $("#product-stock-"+ $(dt).val());
        var choosen = $('input.product-id:checked').length;
        if ($(dt).is(':checked')) {
            ps.attr("required", "required");
            ps.removeAttr("disabled");
            $("#product-stock-"+ $(dt).val()).parent().show();
            $('.btn-submit').show();
        } else {
            ps.removeAttr("required");
            ps.attr("disabled", "disabled");
            $("#product-stock-"+ $(dt).val()).parent().hide();
            if (choosen <= 0) {
                $('.btn-submit').hide();
            }
        }
    }

    $(function () {
        $('#adjustment-form').submit(function () {
            var url = $(this).attr('action');
            $.ajax({
                'beforeSend': function() { $('.loader').show(); },
                'complete': function() { $('.loader').hide(); },
                'url': url,
                'type':'post',
                'data': $('#adjustment-form').serialize(),
                'success': function(data) {
                    console.log(data);
                    if (data.status == 'success') {
                        var alert_success = $('#adjustment-form').find('.alert-success');
                        alert_success.html(data.message);
                        alert_success.show();
                        setTimeout(function () {
                            window.location.reload(true);
                        }, 5000);
                    }
                },
                error: function(XMLHttpRequest, textStatus, errorThrown) {
                    console.log("Status: " + textStatus + " Message: "+errorThrown);
                }
            });

            return false;
        });

        $('#cost-adjustment-form').submit(function () {
            if (confirm('Anda yakin ingin merubah data tersebut?')) {
                var url = $(this).attr('action');
                $.ajax({
                    'beforeSend': function () {
                        $('.loader').show();
                    },
                    'complete': function () {
                        $('.loader').hide();
                    },
                    'url': url,
                    'type': 'post',
                    'data': $('#cost-adjustment-form').serialize(),
                    'success': function (data) {
                        console.log(data);
                        if (data.status == 'success') {
                            var alert_success = $('#cost-adjustment-form').find('.alert-success');
                            alert_success.html(data.message);
                            alert_success.show();
                            setTimeout(function () {
                                window.location.reload(true);
                            }, 5000);
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        console.log("Status: " + textStatus + " Message: " + errorThrown);
                    }
                });
            }
            return false;
        });
    });
</script>
